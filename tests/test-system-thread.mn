load test.case
load system.thread
load system.mutex

class ThreadTest : Test.Case {

	def testSharedReference(self) {

		i = 0
		m = System.Mutex()
		t = System.Thread(def (i, m) {
			m.lock()
			for (i := 0, i := i + 1, i < 100) {
				m.unlock()
				System.wait()
				m.lock()
			}
			m.unlock()
		})

		v = 0
		t.start(i, m)

		m.lock()
		while v < 100 {
			m.unlock()
			System.wait()
			m.lock()
			v = i
		}
		m.unlock()

		self.expectEqual(100, v)
	}
}
